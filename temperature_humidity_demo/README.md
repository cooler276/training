# 概要

* I2C通信を用いてSHTC3温湿度センサから温度と湿度のデータを読み取る。

# 動作

## 初期化

1.  `i2c_init(I2C_PORT, 100 * 1000)` 関数により、指定されたI2Cポート (`I2C_PORT`) を100kHzの通信速度で初期化する。

2.  `gpio_set_function()` 関数を用いて、SDAピン (`I2C_SDA_PIN`) と SCLピン (`I2C_SCL_PIN`) をI2Cの機能として設定する。

3.  `gpio_pull_up()` 関数を用いて、SDAピンとSCLピンに内蔵プルアップ抵抗を有効にする。

4.  `SHTC3_Init()` 関数を呼び出し、SHTC3センサをウェイクアップさせるなどの初期化処理を行う。

    - `shtc3_write_command(SHTC3_REG_WAKEUP)` 関数により、SHTC3にウェイクアップコマンドを送信する。
    - ウェイクアップ後、`sleep_ms(1)` で安定化を待つ。

## 温度・湿度読み取り処理

1.  `shtc3_read_temp_humidity(float *temp, float *humidity)` 関数は、SHTC3センサから温度と湿度のデータを読み取り、指定されたポインタ (`temp`, `humidity`) に格納する。

2.  まず、`shtc3_write_command(SHTC3_REG_NORMAL_T_F)` 関数により、温度を先に読み取るノーマルモードの測定コマンドをSHTC3へ送信する。

3.  測定が完了するまで `sleep_ms(15)` で待機する。

4.  `i2c_read_blocking()` 関数を用いてSHTC3から6バイトの測定データを読み取る。このデータには、温度データ（2バイト）、温度データのCRC（1バイト）、湿度データ（2バイト）、湿度データのCRC（1バイト）が含まれる。

5.  **CRC（巡回冗長検査）について:**

    - CRCは、デジタルデータが伝送中や保存中に誤り（ビット化け）がないかを検出するための誤り検出符号の一種です。送信側がデータから特定の計算方法に基づいてチェックサム（CRC値）を生成し、データと一緒に送信します。受信側も同様の計算をデータに対して行い、得られたCRC値が送信されてきたCRC値と一致するかどうかを比較することで、データの信頼性を検証します。
    - SHTC3センサは、送信する温度データと湿度データそれぞれに対してCRC-8という8ビットのチェックサムを付加しています。このプログラムでは、受信したデータが正しく伝送されたかを確認するために、このCRC-8チェックを行っています。
    - `shtc3_crc8(uint8_t *data, uint16_t len)` 関数がCRC-8の計算を行っています。この関数は、入力されたデータ (`data`) の先頭から指定された長さ (`len`) のバイト数に対して、あらかじめ定義された多項式 (`0x31`) を用いたビット演算を行い、8ビットのCRC値を生成します。
    - `if (shtc3_crc8(read_buf, 2) != read_buf[2] || shtc3_crc8(read_buf + 3, 2) != read_buf[5])` の部分で、受信した温度データ（最初の2バイト）と湿度データ（次の2バイト）に対してそれぞれCRCを計算し、受信したCRC値（それぞれ3バイト目と6バイト目）と比較しています。もし計算されたCRC値と受信したCRC値が一致しない場合、データが破損している可能性が高いため、エラーメッセージを出力して処理を中断します。

6.  読み取った生の温度データ（16ビット）と湿度データ（16ビット）を、それぞれの変換式に基づいて浮動小数点型の温度（℃）と湿度（%RH）に変換する。

    - 温度: `*temp = (float)temp_raw * 175.0f / 65535.0f - 45.0f;`
    - 湿度: `*humidity = (float)humidity_raw * 100.0f / 65535.0f;`

## STOPビットについて

I2C通信では、マスターデバイス (この場合はRaspberry Pi Pico) が通信の開始と終了を制御する。<br>**STOPビット**とは通信の終了を示すもの。

- **コマンド送信におけるSTOPビット:** `shtc3_write_command()` 関数では、コマンドの送信が完了した後、`i2c_write_blocking()` 関数の第4引数に `false` を指定することで、STOPビットを送信している。これにより、SHTC3はコマンドの受信が完了したことを認識し、処理を開始する。

- **データ読み取り処理におけるSTOPビット:** `shtc3_read_temp_humidity()` 関数では、測定コマンドの送信後、続けてデータの読み取りを行うため、`i2c_write_blocking()` (コマンド送信時) 関数の第4引数には `false` を指定し、STOPビットを送信している。データの読み取りは `i2c_read_blocking()` 関数で行われ、読み取り完了後にはSTOPビットが送信される（通常、`i2c_read_blocking()` は読み取り完了後にSTOPビットを送信する）。

    STOPビットを適切に送信することで、I2Cバス上の他のデバイスとの通信の衝突を防ぎ、正常な通信シーケンスを維持することが可能。

## メインループ

1.  `main()` 関数内で、まず `stdio_init_all()` 関数により標準入出力 (USBシリアルなど) を初期化する。

2.  `i2c_init()` 関数と `gpio_set_function()`、`gpio_pull_up()` 関数を用いてI2C通信を初期化する。

3.  `SHTC3_Init()` 関数を呼び出し、SHTC3センサを初期化する。

4.  無限ループ (`while(true)`) に入り、以下の処理を繰り返す。

    - `shtc3_read_temp_humidity()` 関数を呼び出し、温度と湿度のデータを読み取る。
    - 読み取りが成功した場合、読み取った温度と湿度の値をシリアルモニタに出力する。
    - 読み取りが失敗した場合、エラーメッセージをシリアルモニタに出力する。
    - `sleep_ms(1000)` により、1秒間の遅延を設ける。

## 補足

* **I2Cポートとピン:**

    ```c
    #define I2C_PORT i2c0
    #define I2C_SDA_PIN 8
    #define I2C_SCL_PIN 9
    ```

    使用するI2Cポート (`i2c0`) と、SDA (シリアルデータ) ピンとしてGP8、SCL (シリアルクロック) ピンとしてGP9を定義している。

* **SHTC3のI2Cアドレス:**

    ```c
    #define SHTC3_I2C_ADDR 0x70
    ```

    SHTC3センサの一般的なI2Cアドレスとして `0x70` を定義している。

* **SHTC3のレジスタ定義:**

    ```c
    #define SHTC3_REG_NORMAL_T_F (0x7866)
    #define SHTC3_REG_WAKEUP (0x3517)
    ```

    SHTC3のノーマルモード測定コマンド (`0x7866`) とウェイクアップコマンド (`0x3517`) を定義している。

* **I2Cの初期化:**

    `i2c_init()` 関数でI2C通信速度を設定し、`gpio_set_function()` でGPIOピンをI2C機能に割り当て、`gpio_pull_up()` でプルアップ抵抗を有効にしている。I2C通信にはプルアップ抵抗が不可欠。

* **SHTC3へのコマンド送信:**

    `shtc3_write_command()` 関数を用いて、SHTC3にコマンドを送信する。コマンドは上位8ビットと下位8ビットに分割され、I2Cで送信される。

* **SHTC3からのデータ読み取り:**

    `shtc3_read_temp_humidity()` 関数内で、まず測定コマンドを送信し、その後 `i2c_read_blocking()` 関数で温度と湿度の生データを読み取る。

* **CRC-8チェック:**

    受信した温度データと湿度データの整合性を確認するために、`shtc3_crc8()` 関数を用いてCRC-8チェックサムを計算し、受信したCRC値と比較している。**CRC（巡回冗長検査）は、データ伝送時の誤りを検出するための重要な技術であり、SHTC3からのデータが正しく受信できたかを保証するために用いられています。**

* **CMakeLists.txt:** I2C関連の機能を利用するため、`target_link_libraries` に `hardware_i2c` を追加する必要がある。

    ```cmake
        target_link_libraries(temperature_humidity_demo
            hardware_i2c
        )
    ```