# 概要

* WS2812Bなどの制御可能な3色LEDを、HSV色空間に基づいて滑らかに色変化させる。

# 動作

## 初期化

1.  `stdio_init_all()` 関数により、標準入出力 (USBシリアルなど) を初期化する（デバッグや情報出力用）。

2.  使用する PIO (Programmable I/O) コントローラ (`pio0`) とステートマシン (`sm = 0`) を選択する。PIOは、CPUの介入なしにハードウェア的に並列処理を実行できる機能。

3.  `ws2812.pio` ファイルに記述された WS2812 制御用の PIO プログラムを `pio_add_program()` 関数でロードし、そのメモリアドレス (`offset`) を取得する。

4.  `ws2812_program_init()` 関数を呼び出し、WS2812 制御用の PIO プログラムを初期化する。
    * 使用する PIO (`pio`)、ステートマシン (`sm`)、プログラムのオフセット (`offset`)、データピン (`WS2812_PIN`)、通信速度 (`800000` Hz）、RGBW モード (`IS_RGBW = false`) などのパラメータを設定する。
    * この初期化により、指定された GPIO ピンが PIO の制御下に入り、WS2812 との通信準備が整う。

## 色変化処理

1.  `colors_hsv` 配列に、グラデーションの基準となる複数の色相 (Hue) の値を定義する（0-360度の範囲）。彩度 (Saturation) と明度 (Value) は一定の値 (`1.0f`) に設定し、色の鮮やかさと明るさを保つ。

2.  `gradient_steps` で、一つの基準色から次の基準色へ変化する際のステップ数を定義する。ステップ数が多いほど滑らかなグラデーションになる。

3.  `gradient_delay` で、各グラデーションステップ間の遅延時間 (ミリ秒) を定義する。この値が小さいほど、色の変化が速くなる。

4.  メインループ (`while(1)`) 内で、以下の処理を繰り返す。

    * 現在の基準色のインデックス (`current_hue_index`) に基づいて、開始色相 (`start_hue`) を `colors_hsv` 配列から取得する。
    * 次の基準色のインデックス (`next_hue_index`) を計算する。配列の末尾に達したら先頭に戻るように `%` 演算子を使用する。
    * 終了色相 (`end_hue`) を `colors_hsv` 配列から取得する。

5.  `for` ループを用いて、`gradient_steps` の回数だけ以下の処理を繰り返すことで、色のグラデーションを生成する。

    * 現在のステップ数 (`i`) に基づいて、開始色相から終了色相への間の色相 (`current_hue`) を線形に計算する。
    * `hsv_to_rgb()` 関数を呼び出し、計算された HSV 値 (`current_hue`, `saturation`, `value`) を RGB 値 (`r`, `g`, `b`) に変換する。
        * **HSV (Hue, Saturation, Value) について:** HSVは、色の表現方法の一つで、色相（色の種類）、彩度（色の鮮やかさ）、明度（色の明るさ）の3つの要素で色を指定します。RGBよりも人間の色覚に近い表現ができるため、滑らかな色の変化や鮮やかな色の表現に適しています。
        * `hsv_to_rgb()` 関数は、入力された HSV 値を WS2812 が表示できる RGB 値に変換する役割を持ちます。この変換には、数学的な計算が含まれます。

    * `ws2812_send_pixel()` 関数を呼び出し、変換された RGB 値を WS2812 LED に送信する。
        * `ws2812_send_pixel()` 関数は、PIO のステートマシンに RGB データを送り、WS2812 LED を制御します。WS2812 は GRB (Green, Red, Blue) の順でデータを受け取るため、この関数内でデータの順番を調整しています。

    * `sleep_ms(gradient_delay)` 関数で指定された時間だけ待機し、グラデーションの速度を制御する。

6.  グラデーションが終了したら、`current_hue_index` を更新し、次の基準色へのグラデーションを開始する。

## 補足

* **WS2812 と PIO (Programmable I/O):**

    * WS2812 は、1本のデータ線で複数の LED を制御できるシリアル制御のフルカラー LED です。正確なタイミングでデータ信号を送る必要があります。
    * PIO (Programmable I/O) は、Raspberry Pi Pico に搭載された強力な周辺機能の一つで、CPU の負荷を軽減しながら、高速かつ正確なタイミングで外部デバイスと通信を行うことができます。このプログラムでは、PIO を使用して WS2812 の制御信号を生成しています。
    * `ws2812.pio` ファイルには、WS2812 のデータシートに規定されたタイミング要件を満たすための PIO アセンブリ言語のプログラムが記述されています。

* **HSV から RGB への変換:**

    * `hsv_to_rgb()` 関数は、HSV 色空間で表現された色を、WS2812 が表示するために必要な RGB 色空間のデータに変換する重要な役割を担います。この変換アルゴリズムは、色の滑らかな変化を実現するために用いられます。

* **色の定義 (`colors_hsv`):**

    * `colors_hsv` 配列に定義された色相が、色の変化の基準となります。この配列の内容を変更することで、グラデーションのパターンや使用する色を変更できます。

* **グラデーションの制御 (`gradient_steps`, `gradient_delay`):**

    * `gradient_steps` と `gradient_delay` の値を調整することで、色の変化の滑らかさや速度を細かく制御できます。`gradient_steps` を大きくするとより滑らかなグラデーションになりますが、変化に時間がかかります。`gradient_delay` を小さくすると変化が速くなります。

* **CMakeLists.txt:** PIO の機能を利用するため、`target_link_libraries` に `hardware_pio` を追加する必要がある。

    ```cmake
    target_link_libraries(${PROJECT_NAME}
        hardware_pio
    )

    ```

    * `pico_generate_pio_header(rgb_demo ${CMAKE_CURRENT_LIST_DIR}/ws2812.pio)` は、`ws2812.pio` ファイルから C/C++ で使用できるヘッダファイル (`rgb_demo.pio.h`) を生成します。これにより、PIO プログラムを C/C++ コードから簡単に利用できます。
